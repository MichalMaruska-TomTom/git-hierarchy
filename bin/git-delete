#! /usr/bin/zsh -fue

victim=$1

source /usr/share/git-hierarchy/functions.sh
GIT_DIR=$(git_dir)
SUM_DIR=$GIT_DIR/mmc
### detect that nothing depends on it.


## Sums
foreach sum ($SUM_DIR/*)
{
    if grep $victim $sum; then
	cecho red "Sum $sum depends on it"
	exit -1
    fi
}



## segment bases & other refs.
setopt extendedglob
# fixme:
# git for-each-ref
foreach ref ($(git for-each-ref --format="%(refname)" \
     'refs/heads/*' 'refs/base/*' 'refs/start/*'))
{
    # ($GIT_DIR/refs/^remotes/**/*(.))

    # do we grep for "refs/heads/$victim" ??
    if [ -e $GIT_DIR/$ref ]; then
	if grep "ref: refs/heads/$victim" $GIT_DIR/$ref; then
	    cecho red "it's a base for $ref"
	    exit -1
	fi
    else
    # bug: cannot check intermediatery "symlinks"
	if git symbolic-ref $ref |grep $victim; then
	    cecho red "it's a base for $ref"
	    exit -1
	fi
    fi
}

# is it a sum itself?
if [ -e $SUM_DIR/$victim ]; then
    cecho yellow "it's a sum"
fi

# a segment?
if [ -e $GIT_DIR/refs/base/$victim ]; then
    cecho yellow "it's a Segment"

    # fixme:
    git update-ref -d refs/base/$victim
    git update-ref -d refs/start/$victim
fi


git br -d $victim
