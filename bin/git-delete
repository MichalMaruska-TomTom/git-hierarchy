#! /usr/bin/zsh -fue

usage()
{
    cat <<EOF
Usage: ${0##*/} [+-h] [--] ARGS...

Delete a branch, and any mention of it  -- symbolic references.
EOF
}

source /usr/share/git-hierarchy/functions.sh

victim=$1
victim_full=$(git-expand-ref $victim)
victim=${victim#/ref/heads/}
GIT_DIR=$(git_dir)

while getopts :h OPT; do
    case $OPT in
	h|+h)
	    usage
	    exit 0
	    ;;
	*)
	    exit 2
    esac
done
shift OPTIND-1
OPTIND=1

### detect that nothing depends on it.
## Sums
foreach ref ($(git for-each-ref "refs/sums/$sum/" --format "%(refname)"))
{
    if dump_ref $ref| grep -xF "ref: $victim_full"; then
	cecho red "Sum ${ref%refs/sums#/*} depends on it"
	exit -1
    fi
}



## Check dependency: segment bases & other refs.
foreach ref ($(git for-each-ref --format="%(refname)" \
     'refs/heads/*' 'refs/base/*' 'refs/start/*'))
{
    if dump_ref $ref|grep --line-regexp --fixed-strings "ref: $victim_full";
    then
	cecho red "it's a base for $ref"
	exit -1
    fi
}


# is it a sum itself?
if is_sum $victim ; then
    cecho yellow "it's a sum"
fi


# A segment?
if is_segment $victim; then
    cecho yellow "it's a Segment"
    # fixme:
    git update-ref -d refs/base/$victim
    git update-ref -d refs/start/$victim
fi




git branch -d $victim
