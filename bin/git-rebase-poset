#! /usr/bin/zsh -feu

source /usr/share/git-hierarchy/functions.sh
GIT_DIR=$(git_dir)


usage()
{
    cat <<EOF
usage: ${0##*/} [+-h] [--] ARGS...
EOF
}


while getopts :h OPT; do
    case $OPT in
	h|+h)
	    usage
	    exit
	    ;;
	*)
	    usage
	    exit 2
    esac
done
shift OPTIND-1
OPTIND=1


if [ -e $GIT_DIR/.rebasing-segment ]; then
    cecho red "Must first finish rebasing segment " \
	"$(cat $GIT_DIR/.rebasing-segment)"
    exit -1
fi

typeset -a what_to_rebase

if [ $# -gt 0 ]; then
    echo "... down from $1" >&2
    what_to_rebase=($(git-walk-down $1))
else
    what_to_rebase=($(git-tsort))
fi


foreach ref ($what_to_rebase)
{
    # todo: create a tag, so that if `git-rebase' fails
    # at least I see the segment (in gitk).
    #
    cecho green "rebasing $ref"

    if ! git-rebase-ref $ref;
    then
	problem=$?
	cecho red "Failure on $ref"
	exit $problem
    fi
}
