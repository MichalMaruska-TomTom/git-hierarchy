#!/bin/zsh -f

DIFF_SEGMENT="git-diff-segments"

# Given 2 dumps, make clear the difference.
# Exit with 0 status if the are the same.
usage()
{
    cat <<EOF
usage: $0 dump1 dump2

files generated by 'git-dump-refs'
EOF
}
set -x


if [[ $# != 2 ]]; then
    usage
fi
dump1=$1
dump2=$2
GREP=/bin/grep

segment_rx='^segment:'
sum_rx='^sum:'

status=0

if ! diff <($GREP $segment_rx $dump1 |sort ) <($GREP $segment_rx $dump2 |sort)
then
    status=1
fi

if ! diff <($GREP $sum_rx $dump1 |sort ) <($GREP $sum_rx $dump2 |sort )
then
    status=1
fi

cecho blue "now diff single segments"
set +x

# - grep segment hierarchy.dump| sed --silent -e 's|segment: refs/heads/||g;p'
# sed -n  -e '\|segment: refs/heads/|p' hierarchy.dump
# sed --silent -e 's|segment: refs/heads/||g;tp'
# - grep segment $dump1 |sort
foreach segment ( $(sed --silent -e 's|segment: refs/heads/||g;T;p' $dump1 ) )
{
    : ${segment=${segment#refs/heads/}}
    cecho yellow $segment;
    # todo: collect the status
    if ! $DIFF_SEGMENT $segment $dump1 $dump2
    then
        status=1
    fi
}


exit $status
