#!/bin/zsh -euf

# Create a new git-segment, which contains the same sequence of
# patches as a given one, starting off new-base.

source /usr/share/git-hierarchy/functions.sh
GIT_DIR=$(git_dir)

usage()
{
    setopt POSIX_ARGZERO
    cat <<EOF
usage: ${0##*/} [+-h} [--] original new new-base
EOF
    unsetopt POSIX_ARGZERO
}


while getopts :h OPT; do
    case $OPT in
        h|+h)
            usage
            exit 0
            ;;
        *)
            usage >&2
            exit 2
            ;;
    esac
done

shift OPTIND-1
OPTIND=1

if [ $# != 3 ]; then
    echo "missing parameters." >&2
    usage >&2
    exit 2
fi

# re-create the same segment
original=$1
new=$2
new_base=$3

# just clone it, and rebase it:
git branch $new $original
git-segment $new $new_base $(segment_start $original)

# rebase it at a different point:
git-rebase-segment $new
