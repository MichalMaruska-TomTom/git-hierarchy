#! /bin/zsh -feu

source /usr/share/git-hierarchy/functions.sh

usage()
{
    cat <<EOF
usage: ${0##*/} [+-h} [--] [segment]

If segment specified, that segment has its START moved to base.
If no segment is specified, the info on rebase is lost.

So, after this another rebase can start.

EOF
}

while getopts :h OPT; do
    case $OPT in
	h|+h)
	    usage
	    exit 0
	    ;;
	*)
	    usage
	    exit 2
    esac
done
shift $(( OPTIND - 1 ))
OPTIND=1

GIT_DIR=$(git_dir)

mark=$GIT_DIR/.rebasing-segment
# state_dir=$GIT_DIR"/rebase-apply/
# head_name=$(cat "$state_dir"/head-name) &&


# fixme: canonize?
# check that it's a segment!
if [ $# = 1 ]; then
    BRANCH=$1
    BASE="refs/base/${BRANCH#refs/base/}"
    git-segment -r $BRANCH $BASE

    if [ -e $mark -a "$BRANCH" = "$(cat $mark)" ]; then
	echo "### so rebase was completed, moving *start* to the *base*"  >&2
	rm -v $mark
    else
	    echo "### mismatch!"  >&2
    fi
else
    echo "### so rebase was aborted, forgetting about it: $(cat $mark)"  >&2
    rm -vf $mark
    exit 0
fi

# not needed "ref/

