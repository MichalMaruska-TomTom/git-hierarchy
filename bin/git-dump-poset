#! /usr/bin/zsh -feu

# outputs duplicates.

# usage $0 <reference>
#   reference is either sum or segment.
usage()
{
    cat<<EOF
usage: ${0##*/} [+-h} [--] ARGS...
EOF
}


source /usr/share/git-hierarchy/functions.sh
GIT_DIR=$(git_dir)
SUM_DIR=$GIT_DIR/mmc


# recursively dump the poset:
dump_poset()
{
    local base=$1
    local nodes
    typeset -a nodes
    nodes=( $base )

    while [[ ${#nodes} -gt 0 ]]
    do
	# take one: sum -> summands
	# segment -> base.
	# limit base -> stop.

	local first=$nodes[1];
	cecho green $first
	nodes[1]=();

	name=${first#refs/heads/}
	if is_segment $name; then
	    # one could filter those already in.
	    nodes+=( "$(segment_base $name)" )
	elif is_sum $name; then
	    # one could filter those already in.
	    nodes+=( $(summands_of $name) )
	else
	    break
	fi
    done
}



while getopts :h OPT; do
    case $OPT in
	h|+h)
	    usage
	    exit
	    ;;
	*)
	    usage
	    exit 2
    esac
done
shift OPTIND-1
OPTIND=1
dump_poset $(git-expand-ref $1)
