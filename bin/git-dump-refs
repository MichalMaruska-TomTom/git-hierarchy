#!/usr/bin/zsh -feu

# output all relevant references: sums, bases, starts

source /usr/share/git-hierarchy/functions.sh
GIT_DIR=$(git_dir)

MAGIC_FILENAME="hierarchy.dump"

# used as:
# git tag "hierarchy-refs" -m "$(/home/git/my/repo/git-hierarchy/bin/git-dump-refs)"
# git notes add -f -m "$(/home/git/my/repo/git-hierarchy/bin/git-dump-refs)"

## git cat-file tag hierarchy-refs | skip-header| git-recover-symbolic-refs
## git cat-file tag hierarchy-refs | tail -n +6 |  git-recover-symbolic-refs

## skip-header  tail -f5

usage()
{
    cat <<EOF
usage: ${0##*/} [+-ho] [--] ARGS...

-o  outputs into  $MAGIC_FILENAME in cwd.
EOF
}

integer myfd
while getopts :ho OPT; do
    case $OPT in
        h|+h)
            usage
            exit 0
            ;;
        o|+o)
            exec {myfd}>$MAGIC_FILENAME
            ;;
        *)
            usage >&2
            exit 2
    esac
done
shift OPTIND-1
OPTIND=1

##
readonly refs=( $(if [[ $# -ge 1 ]]; then git-walk-down $1; else git-tsort -t ;fi ))

##
foreach ref ( ${(o)refs} )
{
    if git-sum $ref &>/dev/null;
    then
        if git-check-sum $ref;
           then
               cecho red "sum: $ref"
               git-sum $ref
        fi
    elif git-segment $ref &>/dev/null;
    then
        cecho red "segment: $ref"
        git-segment-patches -p $ref
    else
        cecho red "bottom: $ref" $(git rev-parse $ref)
    fi
} >&$myfd
