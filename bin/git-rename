#! /usr/bin/zsh -fue

from=$1
new=$2

source /usr/share/git-hierarchy/functions.sh
GIT_DIR=$(git_dir)
SUM_DIR=$GIT_DIR/mmc

# quoted_regexp.

# replace....

# sum
if is_sum $from; then
    mv $SUM_DIR/$from $SUM_DIR/$new
fi

# dependencies of other sums.
foreach sum ($SUM_DIR/*)
{
    if grep $sum; then
	sed -i -e 's/$from/$new/' $sum
    fi
}


# segment base/start refs.

# rename segment:
if is_segment $from; then
    # fixme:
    mv $GIT_DIR/refs/base/$from $GIT_DIR/refs/base/$new
    mv $GIT_DIR/refs/start/$from $GIT_DIR/refs/start/$new
fi


# fixme: not remotes!
QUOTED_REGEXP=$from
# other bases pointing at this branch.

setopt extendedglob
foreach ref ($GIT_DIR/refs/^remotes/**/*(.))
{
    sed -i -e "s|ref: refs/heads/$QUOTED_REGEXP|ref: refs/heads/$new|g" $ref
}


git branch -m $from $new
